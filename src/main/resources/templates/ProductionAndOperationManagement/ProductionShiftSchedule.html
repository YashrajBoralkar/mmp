<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Production Shift Schedule Form</title>
	<link rel="stylesheet" href="/css/empinfo.css">
	<link rel="stylesheet" href="/css/hrms.css">
	<!-- // for side bar code  -->
	<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>

<body>

	<div th:replace="~{PRODUCTIONANDOPERATION.html :: sidebarFragment}"></div>
	<!-- // for side bar code  -->

	<form id="ShiftscheduleForm" class="form-container" autocomplete="off">
		<!-- Personal Information Section -->
		<h2>Production Shift Schedule Form</h2>
		<input type="hidden" id="id" name="id" th:value="${shift?.id}" />
		<div class="form-row">
			<div class="form-group">
				<label for="productiondepartment">Production Department:</label>
				<input type="text" id="productiondepartment" name="productiondepartment"
					th:value="${shift?.productiondepartment}" required />
			</div>
			<div class="form-group">
				<label for="shiftdate">Shift Date:</label>
				<input type="date" id="shiftdate" name="shiftdate" th:value="${shift?.shiftdate}" required />
			</div>
			<div class="form-group">
				<label for="shiftstarttime">Shift Start Timing:</label>
				<input type="time" id="shiftstarttime" name="shiftstarttime" th:value="${shift?.shiftstarttime}"
					onchange="calculateShiftDuration()" required />
			</div>
			<div class="form-group">
				<label for="shiftendtime">Shift End Timing:</label>
				<input type="time" id="shiftendtime" name="shiftendtime" th:value="${shift?.shiftendtime}"
					onchange="calculateShiftDuration()" required />
			</div>
		</div>
		<!-- First Row -->
		<div class="form-row">
			<div class="form-group">
				<label for="totalshiftduration">Total Shift Duration (hours) :</label>
				<input type="text" id="totalshiftduration" name="totalshiftduration"
					th:value="${shift?.totalshiftduration}" readonly />
			</div>
			<div class="form-group">
				<label>Production Planning ID: </label>
				<br>
				<select id="productionplanninguid" name="productionplanninguid"
					onchange="fetchProductionPlanningDetails(this.value)" th:if="${shift == null or shift.id == null}"
					required>
					<option value="">Select Production ID</option>
					<option th:each="uid : ${productionplanninguid}" th:value="${uid}" th:text="${uid}"></option>
				</select>
				<input type="text" id="productionplanninguid" name="productionplanninguid"
					onchange="fetchProductionPlanningDetails(this.value)" th:value="${shift?.productionplanninguid}"
					readonly th:if="${shift?.id != null}">
			</div>
			<div class="form-group">
				<label>Product ID:</label>
				<br>
				<input type="text" id="productuid" name="productuid" readonly>
			</div>
			<div class="form-group">
				<label for="productname">Product Name:</label>
				<br>
				<input type="text" id="productname" name="productname" readonly>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group">
				<label for="empbatchuid">Employee Batch ID:</label>
				<select id="empbatchuid" name="empbatchuid" th:if="${shift == null or shift.id == null}" multiple>
					<option value="">-- Select Employee Batch ID --</option>
					<option th:each="uid : ${empbatchuid}" th:value="${uid}" th:text="${uid}"></option>
				</select>

				<input type="text" id="empbatchuid" name="empbatchuid" th:value="${shift?.empbatchuid}" readonly
					th:if="${shift?.id != null}">
			</div>
			<div class="form-group">
				<label for="batchname">Batch Name:</label>
				<input type="text" id="batchname" name="batchname" th:value="${shift?.batchname}" readonly />
			</div>

			<div class="form-group">
				<label for="selectedEmpUids">Employee ID:</label>
				<select id="selectedEmpUids" name="selectedEmpUids" th:if="${shift == null or shift.id == null}" multiple onchange="empDetails(this)">
					<option value="">-- Select Employee ID --</option>
					<option th:each="uid : ${employeeuid}" th:value="${uid.employeeuid}" th:text="${uid.employeeuid}"></option>
				</select>
				<input type="text" id="employeeuid" name="employeeuid" 
				       th:value="${shift?.employeeuid}" readonly 
				       th:if="${shift?.id != null}">

			</div>
		</div>
		<!-- Second Row -->
		<div class="form-row">
			<div class="form-group" th:if="${shift == null or shift.id == null}">
				<label for="employeeuid">Selected Employee IDs:</label>
				<input type="text" id="employeeuid" name="employeeuid" readonly
					placeholder="Selected UIDs will appear here">
			</div>

			<div class="form-group">
				<label for="emplyeenames">Employee Full Name:</label>
				<input type="text" id="emplyeenames" name="emplyeenames" th:value="${shift?.emplyeenames}" multiple readonly />
			</div>

			<div class="form-group">
				<label for="workstation">Workstation Assigned:</label>
				<input type="text" id="workstation" name="workstation" th:value="${shift?.workstation}" required />
			</div>
			<div class="form-group">
    <label for="breaktiming">Break Type:</label>
    <select id="breaktiming" name="breaktiming" required onchange="toggleBreakInputs()">
        <option value="" disabled selected>-- Select Break Type --</option>
        <option value="lunch" th:selected="${shift?.breaktiming== 'lunch'}">Lunch Break</option>
        <option value="tea" th:selected="${shift?.breaktiming == 'tea'}">Tea Break</option>
    </select>
</div>

		</div>

		<div id="breakTimeInputs" style="display: none;">
			<label>Break Start Timing:</label>
			<input type="time" id="breakstarttime" name="breakstarttime" th:value="${shift?.breakstarttime}" required />
			<span>Break End Timing:</span>
			<input type="time" id="breakendtime" name="breakendtime" th:value="${shift?.breakendtime}" required />
		</div>
		<!-- Third Row -->
		<div class="form-row">
			<div class="form-group">
				<label for="totalshiftcountperday">Total Shift Count per Day:</label>
				<input type="number" id="totalshiftcountperday" name="totalshiftcountperday" min="1"
					placeholder="e.g. 3" th:value="${shift?.totalshiftcountperday}" required />
			</div>
			<div class="form-group">
			    <label for="supervisoruid">Supervisor:</label>

			    <!-- ADD MODE -->
			    <select id="supervisoruid" name="supervisoruid"
			            th:if="${shift == null or shift.id == null}" required>
			        <option value="">-- Select Supervisor --</option>
			        <option th:each="entry : ${supervisorMap}"
			                th:value="${entry.key}"
			                th:text="${entry.key + ' - ' + entry.value}">
			        </option>
			    </select>

			    <!-- EDIT MODE -->
			    <input type="text" th:if="${shift != null and shift.id != null}"
			           th:value="${shift.supervisoruid + (supervisorMap[shift.supervisoruid] != null ? ' - ' + supervisorMap[shift.supervisoruid] : '')}"
			           readonly />

			    <!-- Hidden field to submit only UID -->
			    <input type="hidden" th:if="${shift != null and shift.id != null}"
			           name="supervisoruid"
			           th:value="${shift.supervisoruid}" />
			</div>
		</div>
		<!-- Actions -->
		<div class="form-actions">
			<button type="button" onclick="submitForm()">Submit</button>
			<button type="button" class="back-button" onclick="goback();">Back</button>
		</div>
	</form>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		function goback() {
			window.location.href = '/productionandoperationmanagement/productionshiftschedulegrid';
		}
	</script>

	<!-- Employee details fetch -->
	<script>
		function empDetails(selectElement) {
			const displayField = document.getElementById('employeeuid');
			let namearr = [];
			const selectedValues = Array.from(selectElement.selectedOptions)
				.map(option => option.value)
				.filter(val => val !== "");
			selectedValues.forEach(uid => {
				$.ajax({
					url: '/getfullnamebyemployeeuid',
					method: 'GET',
					data: {employeeuid: uid},
					success: function (response) {
						if (response && response.length > 0) {
							let fullName = response[0].fullname;
							namearr.push(fullName);
							let displaynames = namearr.join(', ');
							$('#emplyeenames').val(displaynames);
						}
					}
				});
			});
			displayField.value = selectedValues.join(',');
		}
	</script>

	<!-- Supervisor & batch name fetch -->
	<script>
		let batchNameMap = {};
		function updateBatchNameField(names) {
			$('#batchname').val(names.join(','));
		}
		function supervisorDetails(supervisoruid) {
			if (!supervisoruid) return;
			$.ajax({
				url: '/getfullnamebyemployeeuid',
				method: 'GET',
				data: {employeeuid : supervisoruid},
				success: function (response) {
					let fullName = response[0].fullname;
					$('#supervisorname').val(fullName);
				}
			});
		}
		$('#empbatchuid').on('change', function () {
			let selectedUIDs = Array.from(this.selectedOptions).map(opt => opt.value).filter(val => val);
			let batchNames = [];
			let pendingUIDs = [];
			selectedUIDs.forEach(uid => {
				if (batchNameMap[uid]) {
					batchNames.push(batchNameMap[uid]);
				} else {
					pendingUIDs.push(uid);
				}
			});
			updateBatchNameField(batchNames);
			pendingUIDs.forEach(uid => {
				$.ajax({
					url: '/getbatchnamebyempbatchuid',
					method: 'GET',
					data: {empbatchuid: uid},
					success: function (response) {
						if (response && response.length > 0) {
							const name = response.join(', ');
							batchNameMap[uid] = name;
							let updatedNames = selectedUIDs.map(id => batchNameMap[id]).filter(Boolean);
							updateBatchNameField(updatedNames);
						}
					}
				});
			});
		});
	</script>

	<!-- Production planning fetch -->
	<script>
		$(document).ready(function () {
			var existingproductionplanninguid = $('#productionplanninguid').val();
			if (existingproductionplanninguid) {
				fetchProductionPlanningDetails(existingproductionplanninguid);
			}
		});
		function fetchProductionPlanningDetails(productionplanninguid) {
			if (!productionplanninguid) return;
			$.ajax({
				url: '/fetchproductionplanningdetailsbyid',
				method: 'GET',
				data: {productionplanninguid: productionplanninguid},
				success: function (response) {
					$('#productuid').val(response[0].productuid);
					$('#productname').val(response[0].productname);
				},
				error: function () {
					alert('Error fetching Product Details. Please try again.');
				}
			});
		}
	</script>

	<!-- Duration, break & validations -->
	<script>
		function calculateShiftDuration() {
			const startTime = document.getElementById("shiftstarttime").value;
			const endTime = document.getElementById("shiftendtime").value;
			if (!startTime || !endTime) return;
			const [startHour, startMinute] = startTime.split(':').map(Number);
			const [endHour, endMinute] = endTime.split(':').map(Number);
			const start = new Date(0, 0, 0, startHour, startMinute, 0);
			let end = new Date(0, 0, 0, endHour, endMinute, 0);
			if (end < start) { end.setDate(end.getDate() + 1); }
			const diffMs = end - start;
			const diffHours = diffMs / 1000 / 60 / 60;
			document.getElementById("totalshiftduration").value = diffHours.toFixed(2);
		}
		function toggleBreakInputs() {
			const breakType = document.getElementById("breaktiming").value;
			const breakDiv = document.getElementById("breakTimeInputs");
			if (breakType === "lunch" || breakType === "tea") {
				breakDiv.style.display = "block";
			} else {
				breakDiv.style.display = "none";
				document.getElementById("breakstarttime").value = "";
				document.getElementById("breakendtime").value = "";
			}
		}

		/* ---------- Popup Validation + Submit ---------- */
		function submitForm() {
		    const productionDepartment = $('#productiondepartment').val().trim();
		    const shiftDate = $('#shiftdate').val();
		    const shiftStart = $('#shiftstarttime').val();
		    const shiftEnd = $('#shiftendtime').val();
		    const totalDuration = parseFloat($('#totalshiftduration').val());
		    const empBatchUid = $('#empbatchuid').val();
		    const employeeUids = $('#employeeuid').val();
		    const workstation = $('#workstation').val().trim();
		    const breakType = $('#breaktiming').val();
		    const breakStart = $('#breakstarttime').val();
		    const breakEnd = $('#breakendtime').val();
		    const totalShiftCount = $('#totalshiftcountperday').val();

		    let supervisorUid = $('#supervisoruid').val();  // ADD mode (dropdown)
		    let hiddenSupervisorUid = $('input[name="supervisoruid"]').val();  // EDIT mode (hidden field)

		    const productionPlanningId = $('#productionplanninguid').val();

		    // ✅ Production Planning ID validation
		    if (!productionPlanningId || productionPlanningId.trim() === "") {
		        alert("Production Planning ID is required.");
		        return;
		    }

		    if (!productionDepartment) { alert("Production Department is required."); return; }
		    if (!/^[A-Za-z\s]+$/.test(productionDepartment)) { alert("Production Department should only contain letters."); return; }
		    if (!shiftDate) { alert("Shift Date is required."); return; }
		    if (!shiftStart) { alert("Shift Start Time is required."); return; }
		    if (!shiftEnd) { alert("Shift End Time is required."); return; }

		    const [startHour, startMinute] = shiftStart.split(':').map(Number);
		    const [endHour, endMinute] = shiftEnd.split(':').map(Number);
		    let start = new Date(0, 0, 0, startHour, startMinute, 0);
		    let end = new Date(0, 0, 0, endHour, endMinute, 0);
		    if (end < start) { end.setDate(end.getDate() + 1); }
		    const calculatedDuration = ((end - start) / 1000 / 60 / 60).toFixed(2);
		    if (parseFloat(calculatedDuration) !== totalDuration) {
		        alert("Total Shift Duration does not match Shift Start and End Time.");
		        return;
		    }

		    if (!empBatchUid || empBatchUid.length == 0) { alert("Please select at least one Employee Batch UID."); return; }
		    if (!employeeUids) { alert("Please select at least one Employee UID."); return; }
		    if (!workstation) { alert("Workstation is required."); return; }

		    if (!breakType) { 
		        alert("Please select a Break Type."); 
		        return; 
		    }
		    if (breakType) {
		        if (!breakStart || !breakEnd) { alert("Please enter Break Start and End Time."); return; }
		        const [bStartHour, bStartMinute] = breakStart.split(':').map(Number);
		        const [bEndHour, bEndMinute] = breakEnd.split(':').map(Number);
		        const bStart = new Date(0, 0, 0, bStartHour, bStartMinute, 0);
		        const bEnd = new Date(0, 0, 0, bEndHour, bEndMinute, 0);
		        if (bStart < start || bEnd > end) { alert("Break timings should be within Shift timings."); return; }
		        if (bEnd <= bStart) { alert("Break End Time should be after Break Start Time."); return; }
		    }

		    if (!totalShiftCount || totalShiftCount <= 0) { alert("Total Shift Count per Day must be greater than 0."); return; }

		    if ((!supervisorUid || supervisorUid.trim() === "") && (!hiddenSupervisorUid || hiddenSupervisorUid.trim() === "")) {
		        alert("Supervisor selection is required.");
		        return;
		    }

		    // ✅ Proceed with save/update
		    const formElement = document.getElementById('ShiftscheduleForm');
		    const formData = new FormData(formElement);
		    const id = $('#id').val();
		    let url, successMessage;
		    if (!id) { 
				url = '/saveproductionshiftscheduleform'; 
				successMessage = 'Shift Schedule Details Saved Successfully!'; 
				}
		    else {
				 url = '/updateproductionshiftschedule'; 
				 successMessage = 'Shift Schedule Details Updated Successfully!';
				 }

		    $.ajax({
		        url: url,
		        type: 'POST',
		        data: formData,
		        processData: false,
		        contentType: false,
		        success: function () {
		            alert(successMessage);
		            window.location.href = '/productionandoperationmanagement/productionshiftschedulegrid';
		            resetForm();
		        },
		        error: function (xhr, status, error) {
		            alert("Error: " + error);
		        }
		    });
		}

		function resetForm() {
			$('#ShiftscheduleForm')[0].reset();
			$('#id').val('');
		}
		
		$(document).ready(function () {
		    // existing fetchProductionPlanningDetails logic already here...
		    
		    // ✅ Also auto-show break inputs if editing
		    toggleBreakInputs();
		});
		function toggleBreakInputs() {
		    const breakType = document.getElementById("breaktiming").value;
		    const breakDiv = document.getElementById("breakTimeInputs");
		    if (breakType === "lunch" || breakType === "tea") {
		        breakDiv.style.display = "block";   // show in edit
		    } else {
		        breakDiv.style.display = "none";
		        document.getElementById("breakstarttime").value = "";
		        document.getElementById("breakendtime").value = "";
		    }
		}

	</script>
</body>
</html>
