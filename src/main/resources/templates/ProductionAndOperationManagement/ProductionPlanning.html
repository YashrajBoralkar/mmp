<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Production Plan Form</title>
    <link rel="stylesheet" href="/css/empinfo.css">
  <link rel="stylesheet" href="/css/hrms.css"> <!-- // for side bar code  -->
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
   <style>
		.materials-table {
		    width: 100%;
		    border-collapse: collapse;
		    margin-top: 10px;
		    background-color: #fff;
		    box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
		}
		

		.materials-table th,
		.materials-table td {
		    border: 1px solid #ccc;
		    padding: 8px 10px;
			padding-left: 20px !important; /* Use !important to override other CSS */
			   text-align: left !important;
		}


		/* ✅ Shift header text to the left with padding */
				.materials-table th {
				    text-align: left;
				    padding-left: 20px;
				    background-color: #f2f2f2;
				    font-weight: bold;
				}
		.materials-table input {
		    width: 100%;
		    border: none;
		    background-color: transparent;
		    font-size: 14px;
		    padding: 4px;
		}

		.materials-table input[readonly] {
		    background-color: #f9f9f9;
		}

		.materials-table tbody tr:nth-child(even) {
		    background-color: #f9f9f9;
		}
		
		
	</style>
	
</head>
<body>
<div th:replace="~{PRODUCTIONANDOPERATION.html :: sidebarFragment}"></div> <!-- // for side bar code  -->                                                     
<div class="form-container">
    <div class="form-section active" id="section1" style="margin-left: 20px; margin-right: 20px;">
        <h2 id="form-title">ProductionPlanning Form</h2><br>

        <form id="ProductionPlanForm">
            <input type="hidden" id="productionplanninguid" name="productionplanninguid">

            <!-- Row 1: Product UID, Product Name -->
            <div class="form-row">
                <div class="form-group">
                    <label>Product ID:</label>
                    <select name="productuid" id="productuid" onchange="handleProductUidChange(this)">
                        <option value="">--Select--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" name="productname" id="productname"readonly>
                </div>
            </div>

            <!-- Row 2: Material Requirements Table -->
            <div class="form-row" id="receivedMaterialsSection" style="display: none; width: 100%;">
                <div class="form-group" style="width: 100%;">
                    <label>Material Requirements</label>
                    <div id="material-list" class="material-list">
                        <table class="materials-table">
                            <thead id="receivedMaterialsHeader">
                                <tr>
                                    <th>Raw Material Name</th>
                                    <th>Actual Quantity</th>
                                    <th>Expected Quantity</th>
                                    <th>Difference</th>
                                </tr>
                            </thead>
                            <tbody id="receivedMaterialsTable">
                                <!-- Filled dynamically by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Row 3: Production Type, Responsible Manager ,Production Start Date   -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productiontype">Production Type: </label>
                    <select id="productiontype" name="productiontype" required>
                        <option value="">--Select--</option>
                        <option value="Make-to-Order">Make-to-Order</option>
                        <option value="Make-to-Stock">Make-to-Stock</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="responsiblemanager">Responsible Manager:</label>
                    <select id="responsiblemanager" name="responsiblemanager" required></select>
                </div>
                <div class="form-group">
                    <label for="productionstartdate">Production Start Date:</label>
                    <input type="date" id="productionstartdate" name="productionstartdate" required>
                </div>
            </div>

            <!-- Row 4: Production End Date, Production Cost Estimation,Lead Time (Days)  -->
            <div class="form-row">
                <div class="form-group">
                    <label for="productionenddate">Production End Date: <span class="required">:</span></label>
                    <br>
                    <input type="date" id="productionenddate" name="productionenddate" required>
                </div>
                <div class="form-group">
                    <label for="productioncostestimation">Production Cost Estimation:</label>
                    <input type="number" step="0.01" id="productioncostestimation" name="productioncostestimation" required>
                </div>
                <div class="form-group">
                    <label for="leadtimedays">Lead Time (Days) <span class="required">:</span></label>
                    <br>
                    <input type="number" id="leadtimedays" name="leadtimedays" required>
                </div>
            </div>

            <!-- Row 5: Production Dependencies,Approval Status,Remarks -->
            <div class="form-row">
               <div class="form-group" >
                    <label for="productiondependencies">Production Dependencies:</label>
                    <input type="text" id="productiondependencies" name="productiondependencies" rows="2">
                </div>
                <div class="form-group">
                    <label for="approvalstatus">Approval Status: </label>
                    <br>
                    <select id="approvalstatus" name="approvalstatus" required>
                        <option value="">--Select--</option>
                        <option value="Approved" >Approved</option>
                        <option value="Pending">Pending</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks:</label>
                    <br>
                    <input type="text" id="remarks" name="remarks" rows="2">
                </div>
                
            </div>

            <!-- Row 6: Approved By -->
            <div class="form-row">
              <div class="form-group">
                    <label for="approvedby">Approved By:</label>
                    <br>
                    <select id="approvedby" name="approvedby" required></select>
                </div>  
                
                  <div class="form-group">
                    <label for="productionplanningcompletionstatus">Production Planning Completion Status:</label>
                    
                    <select id="productionplanningcompletionstatus" name="productionplanningcompletionstatus" required>
                        <option value="">--Select--</option>
                        <option value="Approved" >Approved</option>
                        <option value="Pending">Pending</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                
            </div>

            <!-- Row 7: Buttons -->
            <div class="form-actions">
                <button type="button" id="saveBtn" onclick="saveProductionPlan()">SAVE</button>
                <button type="button"  onclick="goback()">Back</button>
            </div>
        </form>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Your HTML structure remains the same until the <script> section -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function goback() {
	window.location.href = '/productionandoperationmanagement/productionplanninggrid';
}
</script>
<script>

    $(document).ready(function () {
        updateProductUidDropdown();
        loadEmployeeDropdowns();

        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const uid = urlParams.get('uid');

        if (mode === 'update' && uid) {
            loadPlanForUpdate(uid);
        }
    });

    function loadEmployeeDropdowns() {
        $.ajax({
            url: '/getEmployeeNameList',
            method: 'GET',
            success: function (employees) {
                const resMgr = $('#responsiblemanager');
                const apprBy = $('#approvedby');
                resMgr.empty().append('<option value="">--Select--</option>');
                apprBy.empty().append('<option value="">--Select--</option>');
                employees.forEach(emp => {
                    const name = emp.name;
                    resMgr.append(`<option value="${name}">${name}</option>`);
                    apprBy.append(`<option value="${name}">${name}</option>`);
                });
            }
        });
    }

    function generateProductionuid() {
        const randomFourDigits = Math.floor(1000 + Math.random() * 9000);
        return "PPID" + randomFourDigits;
    }

    function updateProductUidDropdown() {
        $.ajax({
            url: '/getProductUIds',
            method: 'GET',
            success: function (uids) {
                const select = $('#productuid');
                select.empty().append('<option value="">--Select--</option>');
                uids.forEach(uid => {
                    select.append(`<option value="${uid}">${uid}</option>`);
                });
            }
        });
    }

    function handleProductUidChange(select) {
        const productuid = select.value;
        if (!productuid) return;
        $.ajax({
            url: '/getProductNames',
            method: 'GET',
            data: { productuid },
            success: function (names) {
                if (names.length > 0) {
                    $('#productname').val(names[0]);
                    fetchMaterialsByProductName(names[0]);
                }
            }
        });
    }

    function fetchMaterialsByProductName() {
    const productname = $("#productname").val(); // Assuming you have an input or select with id=productname
    const table = $("#materialTable"); // Your target table element
    const section = $("#materialSection"); // Section wrapper to hide/show
    const error = $("#errorMessage");

    table.empty();
    section.hide(); // Reset view
    error.text("");

    if (productname === "") {
        error.text("Please select a product name.");
        return;
    }

    $.ajax({
        url: '/getMaterialsByProductName',
        method: 'GET',
        data: { productname },
        success: function (materials) 
         {
             const section = $("#receivedMaterialsSection");
			    const table = $("#receivedMaterialsTable");

			    table.empty(); // Clear old rows
			    section.hide(); // Always hide first (reset)
            if (materials.length === 0) {
                table.append("<tr><td colspan='4'>No materials found for the selected product.</td></tr>");
                return;
            }

            section.show();

            materials.forEach(matObj => {
                const mat = matObj.rawmaterialname;
                const rawmaterialuid = matObj.rawmaterialuid;
                const uid = `${productname}_${mat}`;

                $.ajax({
                    url: '/getAvailableQuantity',
                    method: 'GET',
                    data: { rawmaterialuid: rawmaterialuid  },
                    success: function (availableQty) {
                        const row = `
                            <tr data-rawmaterialuid="${rawmaterialuid}">
                                <td><input type="text" name="rawmaterialname_${uid}" value="${mat}" readonly></td>
                                <td><input type="number" name="actual_${uid}" value="${availableQty}" readonly class="quantity-input"></td>
                                <td><input type="number" name="expected_${uid}" oninput="calculateDiff('${uid}')" class="quantity-input" ${$('#form-title').text().includes('Update') ? 'readonly' : ''}></td>
                                <td><input type="number" name="diff_${uid}" readonly class="quantity-input"></td>
                            </tr>`;
                        table.append(row);
                    }
                });
            });
        }
    });
}

    function calculateDiff(uid) {
        const actual = parseFloat($(`input[name='actual_${uid}']`).val()) || 0;
        const expected = parseFloat($(`input[name='expected_${uid}']`).val()) || 0;
        $(`input[name='diff_${uid}']`).val(actual - expected);
    }

    function saveProductionPlan() {
        let productionplanninguid = $('#productionplanninguid').val();
        const isUpdate = $('#form-title').text().includes("Update");

        if (!productionplanninguid && !isUpdate) {
            productionplanninguid = generateProductionuid();
        }

        const productuid = $('#productuid').val();

        if (!isUpdate && (!productuid || productuid.trim() === '')) {
            alert("Please select Product UID.");
            return;
        }

        const startDate = $('#productionstartdate').val();
        const endDate = $('#productionenddate').val();
        const dependencies = $('#productiondependencies').val().trim();
        const remarks = $('#remarks').val().trim();
        const cost = parseFloat($('#productioncostestimation').val());
        const leadDays = parseInt($('#leadtimedays').val());

        const validTextRegex = /^[A-Za-z\s]+$/;

        if (!startDate || !endDate) {
            alert("Please select both Production Start Date and End Date.");
            return;
        }

        if (new Date(endDate) < new Date(startDate)) {
            alert("Production End Date must be after the Start Date.");
            return;
        }

        if (dependencies && !validTextRegex.test(dependencies)) {
            alert("Production Dependencies should contain only alphabets and spaces.");
            return;
        }

        if (remarks && !validTextRegex.test(remarks)) {
            alert("Remarks should contain only alphabets and spaces.");
            return;
        }

        if (isNaN(cost) || cost < 0) {
            alert("Production Cost Estimation must be a non-negative number.");
            return;
        }

        if (isNaN(leadDays) || leadDays < 0) {
            alert("Lead Time (Days) must be a non-negative number.");
            return;
        }

        const commonData = {
            productionplanninguid: productionplanninguid,
            productuid: productuid,
            productname: $('#productname').val(),
            productiontype: $('#productiontype').val(),
            productionstartdate: startDate,
            productionenddate: endDate,
            responsiblemanager: $('#responsiblemanager').val(),
            productioncostestimation: cost,
            leadtimedays: leadDays,
            productiondependencies: dependencies,
            approvalstatus: $('#approvalstatus').val(),
            approvedby: $('#approvedby').val(),
            remarks: remarks,
            productionplanningcompletionstatus: $('#productionplanningcompletionstatus').val(),

        };

        if (!isUpdate) {
        	const plans = [];
        	$("#receivedMaterialsTable > tr").each(function () {
        	    const matLabel = $(this).find("label").text().trim();
        	    const rawmaterialuid = $(this).data("rawmaterialuid");
        	    const actual = parseFloat($(this).find("input[name^='actual_']").val()) || 0;
        	    const expected = parseFloat($(this).find("input[name^='expected_']").val()) || 0;
        	    const diff = actual - expected;

        	    plans.push({
        	        ...commonData,
        	        rawmaterialuid: rawmaterialuid,
        	        rawmaterialname: matLabel,
        	        actual: actual,
        	        expected: expected,
        	        diff: diff
        	    });
        	});


            $.ajax({
                url: '/productionplanning/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(plans),
                success: function () {
                    alert("Saved successfully.");
                    window.location.href = "/productionandoperationmanagement/productionplanninggrid";
                },
                error: function (err) {
                    console.error("Save Error:", err);
                    alert("Save failed.");
                }
            });
        } else {
            $.ajax({
                url: '/productionplanning/update',
                type: 'POST',
                data: commonData,
                success: function () {
                    alert("Updated successfully.");
                    window.location.href = "/productionandoperationmanagement/productionplanninggrid";
                },
                error: function (err) {
                    console.error("Update Error:", err);
                    alert("Update failed.");
                }
            });
        }
    }

    function loadPlanForUpdate(uid) {
        $.ajax({
            url: '/productionplanning/getPlanByUid',
            method: 'GET',
            data: { productionplanninguid: uid },
            success: function (data) {
                if (data && data.length > 0) {
                    const plan = data[0];
                    $('#productionplanninguid').val(plan.productionplanninguid);
                    $('#productuid').val(plan.productuid).prop('disabled', true).change();
                    $('#productname').val(plan.productname);
                    $('#productiontype').val(plan.productiontype);
                    $('#productionstartdate').val(plan.productionstartdate);
                    $('#productionenddate').val(plan.productionenddate);
                    $('#responsiblemanager').val(plan.responsiblemanager);
                    $('#productioncostestimation').val(plan.productioncostestimation);
                    $('#leadtimedays').val(plan.leadtimedays);
                    $('#productiondependencies').val(plan.productiondependencies);
                    $('#approvalstatus').val(plan.approvalstatus);
                    $('#approvedby').val(plan.approvedby);
                    $('#remarks').val(plan.remarks);
                    $('#form-title').text("Update Production Planning");
                    $('#saveBtn').text("UPDATE").off('click').on('click', function () {
                        saveProductionPlan();
                    });
                }
            },
            error: function (err) {
                console.error("Error loading plan for update", err);
                alert("Failed to load data.");
            }
        });
    }
    function goBack() {
    	window.location.href = '/dashboard';
      }
</script>


</body>
</html>