<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payroll Details Form</title>
  <link rel="stylesheet" href="/css/empinfo.css">
    <link rel="stylesheet" href="/css/hrms.css"> <!-- // for side bar code  -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  </head>
<body>
  <div th:replace="~{HRMS.html :: sidebarFragment}"></div> <!-- // for side bar code  -->

  <form id="payrollForm">
    <div class="form-container">
      <input type="hidden" id="id" name="id" th:value="${payrollDetails?.id}">
      
      <div class="form-section active">
        <h2>Payroll Details Form</h2>
        <br>
        <!-- First Row -->
        <div class="form-row">
          <div class="form-group">
            <label for="employeeuid">Employee ID:</label>
            <select id="employeeuid" name="employeeuid" onchange="fetchEmployeDetails(this.value)" th:if="${payrollDetails == null or payrollDetails.id == null}">
              <option value="">Select Employee ID</option>
              <option th:each="uid : ${employeeuid}" th:value="${uid}" th:text="${uid}"></option>
            </select>
			<input type="text" id="employeeuid" name="employeeuid" th:if="${payrollDetails?.id != null}" th:value="${payrollDetails?.employeeuid}" readonly>

          </div>		  
          <div class="form-group">
          <label>First Name:</label>
          <input type="text" id="first_name" name="first_name" readonly>
           </div>
          <div class="form-group">
            <label>Last Name:</label>
          <input type="text" id="last_name" name="last_name" readonly>
            </div>
         
        </div>
        <!-- Second Row -->
        <div class="form-row">
          <div class="form-group">
            <label>Department Name:</label>
          <input type="text" id="departmentname" name="departmentname" readonly>
        </div>
          <div class="form-group">          
            <label>Bank Name:</label>
            <input type="text" name="bankName" th:value="${payrollDetails?.bankName}" required>
          </div>
          <div class="form-group">
            <label>Branch Name:</label>
            <input type="text" name="branchName" th:value="${payrollDetails?.branchName}" required>
          </div>
        
        </div>

        <!-- Third Row -->
        <div class="form-row">
          <div class="form-group">
            <label>Account Holder Name:</label>
            <input type="text" name="accountHolderName" th:value="${payrollDetails?.accountHolderName}" required>
          </div>
          <div class="form-group">
            <label>Bank Account Number:</label>
            <input type="text" name="bankAccountNumber" th:value="${payrollDetails?.bankAccountNumber}" required pattern="\d{10,18}">
          </div>         
          <div class="form-group">
            <label>IFSC Code:</label>
            <input type="text" name="ifscCode" th:value="${payrollDetails?.ifscCode}" required pattern="[A-Z]{4}0[A-Z0-9]{6}">
          </div>
        </div>


		<div class="form-row">
		<!-- Currency Field -->
		<div class="form-group">
		  <label for="currency">Currency:</label>
		  <select id="currency" name="currency" th:value="${payrollDetails?.currency}">
		    <option value="">-- Select Currency --</option> <!-- Blank option added -->
		    <option value="INR" th:selected="${payrollDetails?.currency == 'INR'}">INR</option>
		    <option value="USD" th:selected="${payrollDetails?.currency == 'USD'}">USD</option>
		    <option value="EUR" th:selected="${payrollDetails?.currency == 'EUR'}">EUR</option>
		  </select>
		</div>

		<!-- Tax Residency Status Field -->
		<div class="form-group">
		  <label for="taxResidencyStatus">Tax Residency Status:</label>
		  <select id="taxResidencyStatus" name="taxResidencyStatus" th:value="${payrollDetails?.taxResidencyStatus}">
		    <option value="">-- Select Status --</option> <!-- Blank option added -->
		    <option value="Resident" th:selected="${payrollDetails?.taxResidencyStatus == 'Resident'}">Resident</option>
		    <option value="Non-Resident" th:selected="${payrollDetails?.taxResidencyStatus == 'Non-Resident'}">Non-Resident</option>
		  </select>
		</div>
		  
		  
          <div class="form-group">
            <label>Tax Identification Number (TIN):</label>
            <input type="text" name="taxIdentificationNumber" th:value="${payrollDetails?.taxIdentificationNumber}" required pattern="\d{11}">
          </div>
        </div>
        <br>
        <div class="form-actions">
          <button type="button" id="submitBtn" onclick="submitForm()">Submit</button>
          <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
		  <button type="button" class="back-button" onclick="goback();">Back</button> 
		  <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>                   
		  		    </div>						
       
        </div>
      </div>
    </div>
  </form>
<script> 
function goBack() {
	window.location.href = '/dashboard';
	}
</script>
  <script>
	
	$(document).ready(function() {
			             // Auto-fill Item details when updating
			             var existingEmployeeuid = $('#employeeuid').val();
			             if (existingEmployeeuid) {
			                 fetchEmployeDetails(existingEmployeeuid);
			             }
						 });	
	
						 function goback() {
					window.location.href = '/hrms/EmpGrid';
					 }
  function fetchEmployeDetails(employeeuid) {
      if (!employeeuid)  return;
      
      
      $.ajax({
          url: '/payroll/Edetails',
          method: 'GET',
          data: { employeeuid: employeeuid },
          success: function(response) {
                $('#first_name').val(response.firstName);
                $('#last_name').val(response.lastName);
                $('#departmentname').val(response.departmentname);

             
          },
          error: function() {
              alert('Error fetching purchased details. Please try again.');
          }
      });
  }

  function validateForm() {
       let employeeuid = $('#employeeuid').val();
       let firstName = $('#first_name').val().trim();
       let lastName = $('#last_name').val().trim();
       let department = $('#departmentname').val().trim();
       let bankName = $('[name="bankName"]').val().trim();
       let branchName = $('[name="branchName"]').val().trim();
       let accountHolderName = $('[name="accountHolderName"]').val().trim();
       let bankAccountNumber = $('[name="bankAccountNumber"]').val().trim();
       let ifscCode = $('[name="ifscCode"]').val().trim();
       let currency = $('#currency').val();
       let taxResidencyStatus = $('#taxResidencyStatus').val();
       let tin = $('[name="taxIdentificationNumber"]').val().trim();

       // Regex patterns
       let namePattern = /^[A-Za-z\s]+$/; // Only alphabets and space
       let accountPattern = /^\d{10,18}$/;
       let ifscPattern = /^[A-Z]{4}0[A-Z0-9]{6}$/;
       let tinPattern = /^\d{11}$/;

       // Employee UID
       if (!employeeuid) {
         alert("Please select an Employee UID.");
         return false;
       }

       // First Name
       if (!firstName) {
         alert("First Name is required.");
         return false;
       }
       if (!namePattern.test(firstName)) {
         alert("First Name can only contain alphabets.");
         return false;
       }

       // Last Name
       if (!lastName) {
         alert("Last Name is required.");
         return false;
       }
       if (!namePattern.test(lastName)) {
         alert("Last Name can only contain alphabets.");
         return false;
       }

       // Department Name
       if (!department) {
         alert("Department Name is required.");
         return false;
       }

       // Bank Name
       if (!bankName) {
         alert("Bank Name is required.");
         return false;
       }
       if (!namePattern.test(bankName)) {
         alert("Bank Name can only contain alphabets.");
         return false;
       }

       // Branch Name
       if (!branchName) {
         alert("Branch Name is required.");
         return false;
       }
       if (!namePattern.test(branchName)) {
         alert("Branch Name can only contain alphabets.");
         return false;
       }

       // Account Holder Name
       if (!accountHolderName) {
         alert("Account Holder Name is required.");
         return false;
       }
       if (!namePattern.test(accountHolderName)) {
         alert("Account Holder Name can only contain alphabets.");
         return false;
       }

       // Bank Account Number
       if (!bankAccountNumber) {
         alert("Bank Account Number is required.");
         return false;
       }
       if (!accountPattern.test(bankAccountNumber)) {
         alert("Bank Account Number must be 10 to 18 digits.");
         return false;
       }

       // IFSC Code
       if (!ifscCode) {
         alert("IFSC Code is required.");
         return false;
       }
       if (!ifscPattern.test(ifscCode)) {
         alert("Invalid IFSC Code format (e.g., SBIN0001234).");
         return false;
       }

       // Currency
       if (!currency) {
         alert("Please select Currency.");
         return false;
       }

       // Tax Residency Status
       if (!taxResidencyStatus) {
         alert("Please select Tax Residency Status.");
         return false;
       }

       // Tax Identification Number (TIN)
       if (!tin) {
         alert("Tax Identification Number is required.");
         return false;
       }
       if (!tinPattern.test(tin)) {
         alert("TIN must be exactly 11 digits.");
         return false;
       }

       return true; // âœ… All validations passed
     }

     function submitForm() {
       if (!validateForm()) {
         return; // stop submission if validation fails
       }

       const formData = new FormData(document.getElementById('payrollForm'));
       const id = $('#id').val();
       let url, successMessage;

       if (!id) {
         url = '/addpayroll';
         successMessage = 'Payroll details saved successfully!';
       } else {
         url = '/updatePayroll';
         successMessage = 'Payroll details updated successfully!';
       }

       $.ajax({
         url: url,
         type: 'POST',
         data: formData,
         processData: false,
         contentType: false,
         success: function(response) {
           alert(successMessage);
           resetForm();
           window.location.href = '/hrms/EmpGrid';
         },
         error: function() {
           alert('Error saving payroll details. Please try again.');
         }
       });
     }

     function resetForm() {
       $('#payrollForm')[0].reset();
       $('#id').val('');
     }
  </script>
</body>
</html>