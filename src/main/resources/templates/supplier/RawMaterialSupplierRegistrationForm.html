<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Raw Material Supplier Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/empinfo.css">
    <link rel="stylesheet" href="/css/hrms.css">
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap"rel="stylesheet" />    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .header { display: flex; justify-content: space-between; align-items: center; background-color: #f0f0f0; padding: 10px 20px; }
        .search-box { display: flex; align-items: center; gap: 10px; }
        .search-box button, .back-button { padding: 6px 12px; font-size: 14px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .search-box button:hover, .back-button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
<div th:replace="~{SUPPLIER.html :: sidebarFragment}"></div>

<div class="form-container">
    <div class="form-section active" id="section1" style="margin-left: 20px; margin-right: 20px;">
        <h2>Raw Material Supplier Registration</h2>

        <form id="supplierForm">
            <input type="hidden" id="id" name="id" th:value="${supplier?.id}"/>

            <!-- Supplier Details -->
            <div class="row mb-3">
                <div class="col-md-12 form-group">
                    <label for="suppliername" class="form-label">Supplier Name:</label>
                    <input type="text" id="suppliername" name="suppliername" th:value="${supplier?.suppliername}" class="form-control" placeholder="Enter Supplier Name"/>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3 form-group">
                    <label for="contactperson" class="form-label">Contact Person:</label>
                    <input type="text" id="contactperson" name="contactperson" th:value="${supplier?.contactperson}" class="form-control" placeholder="Enter Contact Person"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="mobilenumber" class="form-label">Mobile Number:</label>
                    <input type="text" id="mobilenumber" name="mobilenumber" th:value="${supplier?.mobilenumber}" class="form-control" placeholder="Enter Mobile Number"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="emailaddress" class="form-label">Email Address:</label>
                    <input type="email" id="emailaddress" name="emailaddress" th:value="${supplier?.emailaddress}" class="form-control" placeholder="Enter Email Address"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="gstnumber" class="form-label">GST Number:</label>
                    <input type="text" id="gstnumber" name="gstnumber" th:value="${supplier?.gstnumber}" class="form-control" placeholder="Enter GST Number"/>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3 form-group">
                    <label for="pannumber" class="form-label">PAN Number:</label>
                    <br>
                    <input type="text" id="pannumber" name="pannumber" th:value="${supplier?.pannumber}" class="form-control" placeholder="Enter PAN Number"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="suppliertype" class="form-label">Supplier Type:</label>
                    <br>
                    <input type="text" id="suppliertype" name="suppliertype" th:value="${supplier?.suppliertype}" class="form-control" placeholder="Enter Supplier Type"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="bankaccountnumber" class="form-label">Bank Account Number:</label>
                    <input type="text" id="bankaccountnumber" name="bankaccountnumber" th:value="${supplier?.bankaccountnumber}" class="form-control" placeholder="Enter Bank Account Number"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="ifsccode" class="form-label">IFSC Code:</label>
                    <br>
                    <input type="text" id="ifsccode" name="ifsccode" th:value="${supplier?.ifsccode}" class="form-control" placeholder="Enter IFSC Code"/>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3 form-group">
                    <label for="paymentterms" class="form-label">Payment Terms:</label>
                    <br>
                    <input type="text" id="paymentterms" name="paymentterms" th:value="${supplier?.paymentterms}" class="form-control" placeholder="Enter Payment Terms"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="compliancecertifications" class="form-label">Compliance Certifications:</label>
                    <input type="text" id="compliancecertifications" name="compliancecertifications" th:value="${supplier?.compliancecertifications}" class="form-control" placeholder="Enter Compliance Certifications"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="websiteurl" class="form-label">Website URL:</label>
                    <br>
                    <input type="url" id="websiteurl" name="websiteurl" th:value="${supplier?.websiteurl}" class="form-control" placeholder="Enter Website URL"/>
                </div>

                <div class="col-md-3 form-group">
                    <label for="registrationdate" class="form-label">Registration Date:</label>
                    <br>
                    <input type="date" id="registrationdate" name="registrationdate" th:value="${supplier?.registrationdate}" class="form-control"/>
                </div>
            </div>

            <!-- Raw Material -->
            <div class="row mb-3">
                <div class="col-md-6 form-group">
                    <label>Raw Material IDs:</label>
                    <select multiple class="form-select" name="rawmaterialuid" id="rawmaterialuid_select" th:if="${supplier == null or supplier.id == null}">
                        <option th:each="mat : ${materialList}" th:value="${mat.rawmaterialuid}" th:text="${mat.rawmaterialuid}" th:selected="${supplier.rawmaterialuid != null and #lists.contains(#strings.arraySplit(supplier.rawmaterialuid, ','), mat.rawmaterialuid)}"></option>
                    </select>
                    <input type="text" id="rawmaterialuid_input" name="rawmaterialuid" th:value="${supplier?.rawmaterialuid}" th:if="${supplier?.id != null}" readonly>
                </div>

                <div class="col-md-6 form-group">
                    <label>Raw Material Names:</label>
                    <textarea id="rawmaterialname" name="rawmaterialname" th:text="${supplier?.rawmaterialname}" class="form-control" style="height: 92px;" readonly></textarea>
                </div>
            </div>

            <!-- Address & Document -->
            <div class="row mb-3">
                <div class="col-md-6 form-group">
                    <label for="businessaddress" class="form-label">Business Address:</label>
                    <textarea id="businessaddress" name="businessaddress" th:text="${supplier?.businessaddress}" class="form-control" rows="3" style="height: 28px;"></textarea>
                </div>

                <div class="col-md-6 form-group">
                    <label for="document" class="form-label">Upload Supplier Document:</label>
                    <input type="file" class="form-control" id="document" name="document"/>
                    <div th:if="${supplier.id != null}">&nbsp;
                        <a th:href="@{'/rawmaterialsupplierregistration/viewdoc/' + ${supplier.id}}" target="_blank">View Existing Document</a>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="submitForm()">Save</button>
                <button type="button" class="btn btn-primary" onclick="goback()">Back</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script> 
function goBack() {
	window.location.href = '/dashboard';
	}
</script>
<script>
function goback() {
    window.location.href = '/supplier/rawmaterialsupplierregistrationgrid';
}

$(document).ready(function () {
    var existingRawMaterialUIDs = $('#rawmaterialuid_input').val();
    if (existingRawMaterialUIDs) {
        fetchRawMaterialDetails(existingRawMaterialUIDs.split(','));
    }

    $('#rawmaterialuid_select').on('change', function () {
        var selectedUIDs = $(this).val();
        if (selectedUIDs) {
            fetchRawMaterialDetails(selectedUIDs);
        } else {
            $('#rawmaterialname').val('');
        }
    });

    function fetchRawMaterialDetails(uids) {
        $.ajax({
            url: '/rawmaterial/fetchMultipleByUids',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(uids),
            success: function (response) {
                $('#rawmaterialname').val(response.map(mat => mat.rawmaterialname).join(','));
            },
            error: function () {
                $('#rawmaterialname').val('');
                Swal.fire('Error', 'Error fetching raw material details.', 'error');
            }
        });
    }
});

// SweetAlert2 validations including GST, PAN, Bank and Document
function submitForm() {
    var suppliername = $('#suppliername').val().trim();
    var contactperson = $('#contactperson').val().trim();
    var mobilenumber = $('#mobilenumber').val().trim();
    var emailaddress = $('#emailaddress').val().trim();
    var gstnumber = $('#gstnumber').val().trim();
    var pannumber = $('#pannumber').val().trim();
    var suppliertype = $('#suppliertype').val().trim();
    var bankaccountnumber = $('#bankaccountnumber').val().trim();
    var ifsccode = $('#ifsccode').val().trim();
    var paymentterms = $('#paymentterms').val().trim();
    var compliancecertifications = $('#compliancecertifications').val().trim();
    var websiteurl = $('#websiteurl').val().trim();
    var registrationdate = $('#registrationdate').val().trim();
    var rawmaterialuid = $('#rawmaterialuid_select').val();
    var businessaddress = $('#businessaddress').val().trim();
    var documentFile = $('#document')[0].files[0];
    var id = $('#id').val();

    var mobileRegex = /^[0-9]{10}$/;
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    var urlRegex = /^(https?:\/\/)?([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w\-.]*)*\/?$/;
    var gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/i;
    var panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/i;
    var bankRegex = /^[0-9]{9,18}$/;

    if (!suppliername) return Swal.fire('Validation Error', 'Supplier Name is required', 'warning');
    if (!contactperson) return Swal.fire('Validation Error', 'Contact Person is required', 'warning');
    if (!mobilenumber) return Swal.fire('Validation Error', 'Valid Mobile Number is required', 'warning');
    if (!mobileRegex.test(mobilenumber)) return Swal.fire('Validation Error', 'Mobile Number must be 10 digits', 'warning');
    if (!emailaddress) return Swal.fire('Validation Error', 'Valid Email Address is required', 'warning');
    if (!emailRegex.test(emailaddress)) return Swal.fire('Validation Error', 'Email Address is invalid', 'warning');

    if (!gstnumber) return Swal.fire('Validation Error', 'GST Number is required', 'warning');
    if (!gstRegex.test(gstnumber)) return Swal.fire('Validation Error', 'GST Number format is invalid', 'warning');

    if (!pannumber) return Swal.fire('Validation Error', 'PAN Number is required', 'warning');
    if (!panRegex.test(pannumber)) return Swal.fire('Validation Error', 'PAN Number format is invalid', 'warning');

    if (!suppliertype) return Swal.fire('Validation Error', 'Supplier Type is required', 'warning');

    if (!bankaccountnumber) return Swal.fire('Validation Error', 'Bank Account Number is required', 'warning');
    if (!bankRegex.test(bankaccountnumber)) return Swal.fire('Validation Error', 'Bank Account Number format is invalid', 'warning');

    if (!ifsccode) return Swal.fire('Validation Error', 'IFSC Code is required', 'warning');
    if (!paymentterms) return Swal.fire('Validation Error', 'Payment Terms is required', 'warning');
    if (!compliancecertifications) return Swal.fire('Validation Error', 'Compliance Certifications are required', 'warning');
    if (!websiteurl) return Swal.fire('Validation Error', 'Website URL is required', 'warning');
    if (!urlRegex.test(websiteurl)) return Swal.fire('Validation Error', 'Website URL is invalid', 'warning');
    if (!registrationdate) return Swal.fire('Validation Error', 'Registration Date is required', 'warning');
    if (!rawmaterialuid || rawmaterialuid.length === 0) return Swal.fire('Validation Error', 'Please select at least one Raw Material', 'warning');
    if (!businessaddress) return Swal.fire('Validation Error', 'Business Address is required', 'warning');
    if (!id && !documentFile) return Swal.fire('Validation Error', 'Please upload Supplier Document', 'warning');

    var formData = new FormData($('#supplierForm')[0]);
    if (rawmaterialuid) formData.set('rawmaterialuid', rawmaterialuid.join(','));
    var url = id ? '/rawmaterialsupplierregistration/update' : '/rawmaterialsupplierregistration/save';

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function () {
            Swal.fire({
                icon: 'success',
                title: id ? 'Updated Successfully!' : 'Saved Successfully!',
                showConfirmButton: true
            }).then(() => {
                window.location.href = '/supplier/rawmaterialsupplierregistrationgrid';
            });
        },
        error: function () {
            Swal.fire('Error', 'An error occurred. Please try again.', 'error');
        }
    });
}
</script>
</body>
</html>
