<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Material Shortage Alert Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        form {
            max-width: 600px;
            margin: auto;
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        textarea[readonly] {
            background-color: #f8f8f8;
            cursor: not-allowed;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <h2>Raw Material Shortage Alert Form</h2>
    <form id="materialShortageAlertForm">
        <input type="hidden" id="id" name="id" th:value="${alert?.id}" />

        <!-- ✅ Hidden field for storing comma-separated UIDs -->
        <input type="hidden" id="rawmaterialuidHidden" name="rawmaterialuid"
               th:value="${alert?.rawmaterialuid}" />

        <!-- ✅ Dropdown for selection (only visible in create mode) -->
        <label for="rawmaterialuidList" th:if="${alert == null or alert.id == null}">
            Raw Material ID :
        </label>
        <select id="rawmaterialuidList"
                name="rawmaterialuidList"
                th:if="${alert == null or alert.id == null}"
                multiple required>
            <option value="">Select Raw Material UID</option>
            <option th:each="uid : ${rawmaterialuid}"
                    th:value="${uid}" th:text="${uid}"></option>
        </select>

        <!-- ✅ Readonly field for edit mode -->
        <label th:if="${alert?.id != null}">Raw Material UID :</label>
        <input type="text"
               id="rawmaterialuidText"
               name="rawmaterialuid"
               th:if="${alert?.id != null}"
               th:value="${alert?.rawmaterialuid}"
               readonly />

        <!-- ✅ Readonly raw material names -->
        <label>Raw Material Name :</label>
        <textarea id="rawmaterialname" name="rawmaterialname"
                  th:text="${alert?.rawmaterialname}"
                  rows="3" readonly></textarea>

        <label for="minimumstocklevel">Minimum Stock Level</label>
        <input type="number" id="minimumstocklevel" name="minimumstocklevel"
               min="0" required th:value="${alert?.minimumstocklevel}" />

        <label for="currentstocklevel">Current Stock Level</label>
        <input type="number" id="currentstocklevel" name="currentstocklevel"
               min="0" required th:value="${alert?.currentstocklevel}" />

        <label for="alertdate">Alert Date</label>
        <input type="date" id="alertdate" name="alertdate"
               th:value="${alert?.alertdate}" required />

        <label for="generatedby">Generated By</label>
        <select id="generatedby" name="generatedby" required>
            <option value="">Select</option>
            <option value="System" th:selected="${alert?.generatedby == 'System'}">System</option>
            <option value="User" th:selected="${alert?.generatedby == 'User'}">User</option>
        </select>

        <button type="button" id="submitBtn" onclick="submitAlertForm()">Submit</button>
        <button type="button" onclick="history.back()">Back</button>

        <div id="message" th:if="${successMessage}"
             class="success-message" th:text="${successMessage}"></div>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let rawMaterialNameMap = {};

        // ✅ When user selects UIDs
        $('#rawmaterialuidList').on('change', function () {
            let selectedUIDs = Array.from(this.selectedOptions)
                .map(opt => opt.value)
                .filter(val => val);

            // ✅ Update hidden field only (no duplicate commas)
            $('#rawmaterialuidHidden').val(selectedUIDs.join(','));

            let rawMaterialNames = [];
            let pendingUIDs = [];

            selectedUIDs.forEach(uid => {
                if (rawMaterialNameMap[uid]) {
                    rawMaterialNames.push(rawMaterialNameMap[uid]);
                } else {
                    pendingUIDs.push(uid);
                }
            });

            updateNamesTextArea(rawMaterialNames);

            // ✅ Fetch names via AJAX
            pendingUIDs.forEach(uid => {
                $.ajax({
                    url: '/shortagealert/getrawmaterialdetails',
                    method: 'GET',
                    data: { rawmaterialuid: uid },
                    success: function (response) {
                        if (response && response.length > 0) {
                            const name = response[0].rawmaterialname;
                            rawMaterialNameMap[uid] = name;
                            let updatedNames = selectedUIDs
                                .map(id => rawMaterialNameMap[id])
                                .filter(Boolean);
                            updateNamesTextArea(updatedNames);
                        }
                    },
                    error: function () {
                        console.error("Error fetching details for UID:", uid);
                    }
                });
            });
        });

        function updateNamesTextArea(names) {
            $('#rawmaterialname').val(names.join(', '));
        }

        function validateAlertForm() {
            const id = $('#id').val();
            const selectedUIDs = $('#rawmaterialuidList').val();
            const minStock = $('#minimumstocklevel').val().trim();
            const currStock = $('#currentstocklevel').val().trim();
            const alertDate = $('#alertdate').val().trim();
            const generatedBy = $('#generatedby').val().trim();

            if ((!selectedUIDs || selectedUIDs.length === 0) && !id) {
                alert("Please select at least one Raw Material UID.");
                return false;
            }

            if (minStock === '' || !/^\d+$/.test(minStock) || parseInt(minStock) < 0) {
                alert("Minimum Stock Level must be a non-negative whole number.");
                return false;
            }

            if (currStock === '' || !/^\d+$/.test(currStock) || parseInt(currStock) < 0) {
                alert("Current Stock Level must be a non-negative whole number.");
                return false;
            }

            if (alertDate === '') {
                alert("Alert Date is required.");
                return false;
            }

            if (generatedBy === '') {
                alert("Please select who generated the alert.");
                return false;
            }

            return true;
        }

        function submitAlertForm() {
            if (!validateAlertForm()) return;

            const fd = new FormData(document.getElementById("materialShortageAlertForm"));
            const id = $('#id').val();
            let url = id ? '/materialshortagealert/update' : '/materialshortagealert/save';
            let successMessage = id ? 'Alert updated successfully!' : 'Alert submitted successfully!';

            $.ajax({
                url: url,
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                success: function () {
                    alert(successMessage);
                    resetForm();
                    window.location.href = '/inventory/rawmaterialshortagealertgrid';
                },
                error: function () {
                    alert('Error submitting the alert. Please try again.');
                }
            });
        }

        function resetForm() {
            $('#materialShortageAlertForm')[0].reset();
            $('#id').val('');
            $('#message').text('');
            $('#submitBtn').text('Submit');
        }
    </script>
</body>
</html>
