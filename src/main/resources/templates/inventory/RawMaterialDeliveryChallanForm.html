
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Raw Material Delivery Challan Form</title>
      <link rel="stylesheet" href="/css/empinfo.css" />
  <link rel="stylesheet" href="/css/hrms.css" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
<div th:replace="~{INVENTORY.html :: sidebarFragment}"></div> <!-- // for side bar code  -->  
<div class="form-container">
  <div class="form-section active" id="section1" style="margin-left: 20px; margin-right: 20px;">
    <h2 class="text-center mb-4">Raw Material Delivery Challan</h2>

    <form id="deliverychallanform">

      <input type="hidden" id="id" name="id" th:value="${challan?.id}" />

      <!-- Row 1 -->
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="rawmaterialpurchaseorderuid">Purchase Order ID <span class="text-danger"></span></label>
          <select class="form-control" id="rawmaterialpurchaseorderuid" name="rawmaterialpurchaseorderuid" th:value="${challan?.rawmaterialpurchaseorderuid}" onchange="fetchPurchaseOrderDetails(this.value)" required>
            <option value="">Select Purchase Order ID</option>
            <option th:each="uid : ${purchaseorderuidList}" th:value="${uid}" th:text="${uid}" th:selected="${challan?.rawmaterialpurchaseorderuid == uid}"></option>
          </select>
        </div>
      </div>

      <!-- Row 2 -->
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="rawmaterialname">Raw Material Name</label>
          <input type="text" id="rawmaterialname" name="rawmaterialname" class="form-control" th:value="${challan?.rawmaterialname}" readonly />
        </div>
        <div class="form-group col-md-4">
          <label for="rawmaterialsupplieruid">Supplier ID</label>
          <input type="text" id="rawmaterialsupplieruid" name="rawmaterialsupplieruid" class="form-control" th:value="${challan?.rawmaterialsupplieruid}" readonly />
        </div>
        <div class="form-group col-md-4">
          <label for="suppliername">Supplier Name <span class="text-danger"></span></label>
          <input type="text" id="suppliername" name="suppliername" class="form-control" th:value="${challan?.suppliername}" readonly />
        </div>
      </div>

      <!-- Row 3 -->
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="rawmaterialuid">Raw Material ID <span class="text-danger"></span></label>
          <input type="text" id="rawmaterialuid" name="rawmaterialuid" class="form-control" th:value="${challan?.rawmaterialuid}" readonly />
        </div>
        <div class="form-group col-md-4">
          <label for="deliverydate">Delivery Date <span class="text-danger"></span></label>
          <input type="date" class="form-control" id="deliverydate" name="deliverydate" th:value="${challan?.deliverydate}" required />
        </div>
        <div class="form-group col-md-4">
          <label for="quantitydelivered">Quantity Delivered</label>
          <input type="number" id="quantitydelivered" name="quantitydelivered" th:value="${challan?.quantitydelivered}" min="1" max="999999" required />
        </div>
      </div>

      <!-- Row 4 -->
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="vehiclenumber">Vehicle Number</label>
          <input type="text" id="vehiclenumber" name="vehiclenumber" th:value="${challan?.vehiclenumber}"
                 maxlength="15"
                 pattern="^[A-Z]{2}[ -]?[0-9]{2}[ -]?[A-Z]{1,3}[ -]?[0-9]{4}$"
                 title="Format: MH 12 AB 1234 (uppercase only, use space or hyphen as separator)"
                 required />
        </div>
        <div class="form-group col-md-4">  
          <label for="receivedby">Received By:</label>
				<!-- CREATE MODE -->
				<select id="receivedby" name="receivedby" th:if="${challan == null or challan.id == null}" required>
					<option value="">Select received by</option>
					<option th:each="entry : ${receivedMap}" th:value="${entry.key + ' - ' + entry.value}"
						th:text="${entry.key + ' - ' + entry.value}">
					</option>
				</select>
				<!-- EDIT MODE -->
				<input type="text" id="receivedby" name="receivedby" th:value="${challan.receivedby}" th:if="${challan?.id != null}"readonly />

			</div>
          
        </div>
   
      <!-- Buttons -->
      <div class="form-actions">
        <button type="button" class="btn btn-primary" onclick="submitForm()">Submit</button>
  		<button type="button" class="back-button" onclick="goback()">Back</button>
       <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
       </div>          
</form>                
</div>
</div> 

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function goback() {
	window.location.href = '/inventory/rawmaterialdeliverychallangrid';
}
</script>



<script>
//     $('#employeeUID').change(function () {
//         const uid = $(this).val();
//         if (!uid) {
//             $('#receivedby').val('');
//             return;
//         }
//         $.ajax({
//             url: '/rawmaterialdeliverychallan/getEmployeeName',
//             method: 'GET',
//             data: { uid: uid },
//             success: function (data) {
//                 $('#receivedby').val(data.employeename || '');
//             },
//             error: function () {
//                 alert('Failed to fetch employee name.');
//             }
//         });
//     });
$(document).ready(function() {
		    // Auto-fill Item details when updating
		    var existingsupplieruid = $('#uid').val();
		    if (existingsupplieruid) {
		    	fetchPurchaseOrderDetails(existingsupplieruid);
		    }
		});
    function fetchPurchaseOrderDetails(uid) {
        if (!uid) return;
        $.ajax({
            url: '/rawmaterialdeliverychallan/fetchPurchaseOrderDetails',
            method: 'GET',
            data: { rawmaterialpurchaseorderuid: uid },
            success: function (response) {
				
                $('#rawmaterialsupplieruid').val(response?.rawmaterialsupplieruid || '');
                $('#suppliername').val(response?.suppliername || '');
                $('#rawmaterialname').val(response?.materialnames || '');
                $('#rawmaterialuid').val(response?.rawmaterialuid || '');
            },
            error: function () {
                alert('Error fetching purchase order details.');
            }
        });
    }

    $(document).ready(function () {
        const today = new Date().toISOString().split('T')[0];
        $('#deliverydate').val(today);
        $('#deliverydate').attr('min', today);
        $('#deliverydate').attr('max', today);
    });

	function validateForm() {
	    let poid = $('#rawmaterialpurchaseorderuid').val();
	    let rmName = $('#rawmaterialname').val();
	    let supplierUid = $('#rawmaterialsupplieruid').val();
	    let supplierName = $('#suppliername').val();
	    let rmUid = $('#rawmaterialuid').val();
	    let deliveryDate = $('#deliverydate').val();
	    let qty = $('#quantitydelivered').val();
	    let vehicle = $('#vehiclenumber').val();
	    let receivedby = $('#receivedby').val();

	    // Purchase Order
	    if (!poid) {
	        alert("Please select Purchase Order ID");
	        return false;
	    }

	    // Raw Material Name
	    if (!rmName) {
	        alert("Raw Material Name is required");
	        return false;
	    }

	    // Supplier UID
	    if (!supplierUid) {
	        alert("Supplier ID is required");
	        return false;
	    }

	    // Supplier Name
	    if (!supplierName) {
	        alert("Supplier Name is required");
	        return false;
	    }

	    // Raw Material ID
	    if (!rmUid) {
	        alert("Raw Material ID is required");
	        return false;
	    }

	    // Delivery Date
	    if (!deliveryDate) {
	        alert("Delivery Date is required");
	        return false;
	    }

	    // Quantity Delivered
	    if (!qty || qty <= 0) {
	        alert("Please enter valid Quantity Delivered (must be greater than 0)");
	        return false;
	    }

	    // Vehicle Number Validation
	    let vehiclePattern = /^[A-Z]{2}[ -]?[0-9]{2}[ -]?[A-Z]{1,3}[ -]?[0-9]{4}$/;

	    if (!vehicle.match(vehiclePattern)) {
	        alert("Invalid Vehicle Number Format! Example: MH 12 AB 1234");
	        return false;
	    }

	    // Received By
	    if (!receivedby) {
	        alert("Please select Received By");
	        return false;
	    }

	    return true; // All validations passed
	}

	
    function submitForm() {
		
		if (!validateForm()) {
		        return; // Stop form submission if validation fails
		    }
		
        const formData = new FormData(document.getElementById('deliverychallanform'));
        const id = $('#id').val();
        let url, successMessage;

        if (!id) {
            url = '/rawmaterialdeliverychallan/save';
            successMessage = 'Raw Material Delivery Challan saved successfully!';
        } else {
            url = '/rawmaterialdeliverychallan/update';
            successMessage = 'Raw Material Delivery Challan updated successfully!';
        }

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function () {
                alert(successMessage);
                resetForm();
                window.location.href = '/inventory/rawmaterialdeliverychallangrid';
            },
            error: function () {
                alert('Error saving form');
            }
        });
    }

    function resetForm() {
        $('#deliverychallanform')[0].reset();
        $('#id').val('');
        $('#form-title').text('Raw Material Delivery Challan Form');
        $('#submitBtn').text('Submit');
    }

</script>

</body>
</html>