<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Adjustment Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 py-10">
    <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6">
        <h1 id="form-title" class="text-2xl font-bold text-gray-800 mb-6">Cost Adjustment Form</h1>
        <form id="costAdjustmentForm" >
            <fieldset class="mb-6">
				<div>
									    <input type="hidden" id="id" name="id" th:value="${costadjustment?.id}">
									</div>
									<!-- Product UID Section -->
									            <fieldset class="mb-6">
									                <legend class="text-lg font-semibold text-gray-700 mb-4">Product Details </legend>
									                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
									                    <div>
									                        <label for="productuid" class="block text-gray-700 font-medium">Product UID (GOODS Only)**</label>
									                        <select id="productuid" name="productuid" class="w-full border rounded px-3 py-2 mt-1"
									                                onchange="fetchProductDetails(this.value)" onclick="fetchstockDetailsaccordingtoproductuid(this.value)">
									                            <option value="">Select Product UID</option>
									                            <option th:each="uid : ${productuid}" th:value="${uid}" th:text="${uid}"></option>
									                        </select>
									                    </div>
														<div>
																												                      <label for="unitcost" class="block text-gray-700 font-medium">Unit Cost**</label>
																												                      <input type="text" step="0.01" id="unitcost" name="unitcost" class="w-full border rounded px-3 py-2 mt-1"th:value="${costadjustment?.unitcost}" required>
																												                  </div>
									                    
									            </fieldset>

														
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					
                    
                   
					
					<div>
							 			            <label for="stockuid" class="block text-gray-700 font-medium">Stock UID **</label>
													<select id="stockuid" name="stockuid" class="w-full border rounded px-3 py-2 mt-1" 
													        onchange="fetchStockDetails(this.value)" 
													        th:if="${costadjustment == null or costadjustment.id == null}">							 							<option value="">Select Stock UID</option>
							 							<option th:each="uid : ${Stockuid}" th:value="${uid}" th:text="${uid}"></option>	
							 			            </select>
							 			        </div>
												
												<input type="text" id="stockuid" name="stockuid" th:value="${costadjustment?.stockuid}" readonly th:if="${costadjustment?.id != null}">
												
												<div>
												                        <label for="stockname" class="block text-gray-700 font-medium">Stock or Lots Name**</label>
												                        <input type="text" id="stockname" name="stockname" class="w-full border rounded px-3 py-2 mt-1"  readonly>
												                    </div>
												
                  
                    <div>
                        <label for="unitquantity" class="block text-gray-700 font-medium"> Quantity</label>
                        <input type="number" id="unitquantity" name="unitquantity" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.unitquantity}" required>
                    </div>
                </div>
            </fieldset>

            <!-- Adjustment Details -->
            <fieldset class="mb-6">
                <legend class="text-lg font-semibold text-gray-700 mb-4">Adjustment Details</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="adjustmentvalue" class="block text-gray-700 font-medium">Adjustment Value**</label>
                        <input type="text" step="0.01" id="adjustmentvalue" name="adjustmentvalue" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.adjustmentvalue}" required>
                    </div>
                    <div>
                        <label for="newcost" class="block text-gray-700 font-medium">New Cost/Valuation**</label>
                        <input type="number" step="0.01" id="newcost" name="newcost" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.newcost}" >
                    </div>
                    <div>
                        <label for="reason" class="block text-gray-700 font-medium">Reason for Adjustment**</label>
                        <textarea id="reason" name="reason" class="w-full border rounded px-3 py-2 mt-1" rows="3"  th:value="${costadjustment?.reason}"required></textarea>
                    </div>
                    <div>
                        <label for="adjustmentdate" class="block text-gray-700 font-medium">Adjustment Date**</label>
                        <input type="date" id="adjustmentdate" name="adjustmentdate" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.adjustmentdate}" required>
                    </div>
                </div>
            </fieldset>

            <!-- Audit and Approvals -->
            <fieldset class="mb-6">
                <legend class="text-lg font-semibold text-gray-700 mb-4">Audit and Approvals</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="adjustedby" class="block text-gray-700 font-medium">Adjusted By**</label>
                        <input type="text" id="adjustedby" name="adjustedby" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.adjustedby}"required>
                    </div>
                    <div>
                        <label for="approvalstatus" class="block text-gray-700 font-medium">Approval Status**</label>
                        <select id="approvalstatus" name="approvalstatus" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.approvalstatus}" required>
                            <option value="">Select Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label for="approvedby" class="block text-gray-700 font-medium">Approved By</label>
                        <input type="text" id="approvedby" name="approvedby" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.approvedby}">
                    </div>
                    <div>
                        <label for="approvaldate" class="block text-gray-700 font-medium">Approval Date</label>
                        <input type="date" id="approvaldate" name="approvaldate" class="w-full border rounded px-3 py-2 mt-1" th:value="${costadjustment?.approvaldate}">
                    </div>
                    <div class="md:col-span-2">
                        <label for="comments" class="block text-gray-700 font-medium">Adjustment Comments</label>
                        <textarea id="comments" name="comments" class="w-full border rounded px-3 py-2 mt-1" rows="3" th:value="${costadjustment?.comments}"></textarea>
                    </div>
                </div>
            </fieldset>

           
                <button type="button" id="submitBtn"class="bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600" onclick="submitForm()">Submit</button>

				<div th:if="${successMessage}" class="success-message" th:value="${successMessage}"></div>

        </form>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<script>		
			
			
			function submitForm() {
		    const formData = new FormData(document.getElementById('costAdjustmentForm'));
		    const id = $('#id').val();
		    let url, successMessage;

		    if (!id) {
		        url = '/costadjustment/save';
		        successMessage = 'Cost adjustment saved successfully!';
		    } else {
		        url = '/costadjustment/update';
		        successMessage = 'Cost adjustment updated successfully!';
		    }

		    $.ajax({
		        url: url,
		        type: 'POST',
		        data: formData,
		        processData: false,
		        contentType: false,
		        success: function(response) {
		            $('#successMessage').text(successMessage);
		            resetForm();
		            window.location.href = '/costadjustment/list';
		        },
		        error: function() {
		            alert('Error saving cost adjustment. Please try again.');
		        }
		    });
		}

		function resetForm() {
		    $('#costAdjustmentForm')[0].reset();
		    $('#id').val('');
		    $('#form-title').text('Cost Adjustment Form');
			$('#submitBtn').text('Updated Stock Valuation');

		}

		function prefillForm(data) {
		    $('#id').val(data.id);
		    $('#stockname').val(data.stockname);
		    $('#stockuid').val(data.stockuid);
		    $('#unitcost').val(data.unitcost);
		    $('#stockquantity').val(data.stockquantity);
		    $('#adjustmentvalue').val(data.adjustmentvalue);
		    $('#newcost').val(data.newcost);
		    $('#reason').val(data.reason);
		    $('#adjustmentdate').val(data.adjustmentdate);
		    $('#adjustedby').val(data.adjustedby);
		    $('#approvalstatus').val(data.approvalstatus);
		    $('#approvedby').val(data.approvedby);
		    $('#approvaldate').val(data.approvaldate);
		    $('#comments').val(data.comments);

			if (data.id) {
					                // If updating, replace dropdown with readonly input
					                $('#stockuid').replaceWith('<input type="text" id="stockuid" name="stockuid" value="' + data.stockuid + '" readonly>');

					            }
			
		    $('#form-title').text('Update Cost Adjustment');
			$('#submitBtn').text('Updated Stock Valuation');

		}
		
		function fetchProductDetails(productuid) {
		               if (!productuid) return;

		               $.ajax({
		                   url: '/getproductdetails',
		                   method: 'GET',
		                   data: { productuid: productuid },
		                   success: function(response) {
		                       if (response) {
		                           $('#unitcost').val(response.unitcost || '');
		                       } else {
		                           alert('No details found for selected product.');
		                       }
		                   },
		                   error: function(xhr, status, error) {
		                       console.error('Error fetching product details:', error);
		                       alert('Error fetching product details. Please try again.');
		                   }
		               });
		           }


		
				   function fetchstockDetailsaccordingtoproductuid(productuid) {
				   		               if (!productuid) return;

				   		               $.ajax({
				   		                   url: '/getstockdetails',
				   		                   method: 'GET',
				   		                   data: { productuid: productuid },
				   		                   success: function(response) {
				   		                       if (response) {
				   		                           $('#unitquantity').val(response.totalstockquantity || '');
				   		                       } else {
				   		                           alert('No details found for selected product.');
				   		                       }
				   		                   },
				   		                   error: function(xhr, status, error) {
				   		                       console.error('Error fetching product details:', error);
				   		                       alert('Error fetching product details. Please try again.');
				   		                   }
				   		               });
				   		           }


				   		
			
			function fetchStockDetails(stockuid) {
						    if (!stockuid) return;

						    $.ajax({
						        url: '/getStockDetails',
						        method: 'GET',
						        data: { stockuid: stockuid },
						        success: function(response) {
						            if (response && response.length > 0) { // Ensure response is not empty
						                let stockData = response[0]; // Get first object from the list
						                $('#stockname').val(stockData.stockname || '');
										 

						                
						            } else {
						                alert('No data found for the selected product.');
						            }
						        },
						        error: function(xhr, status, error) {
						            console.error('Error fetching product details:', error);
						            alert('Error fetching product details. Please try again.');
						        }
						    });
						}
						
						$(document).ready(function () {
						    // Set today's date for Adjustment Date and Approval Date
						    const today = new Date().toISOString().split('T')[0];
						    $('#adjustmentdate, #approvaldate').val(today).attr('max', today);

						    // Prevent users from selecting other dates
						    $('#adjustmentdate, #approvaldate').on('change', function () {
						        if ($(this).val() !== today) {
						            alert('You can only select todayâ€™s date.');
						            $(this).val(today);
						        }
						    });

						    // Validation for Adjustment Value (Only digits allowed)
						    $('#adjustmentvalue').on('input', function () {
						        let value = $(this).val();
						        if (!/^\d*$/.test(value)) {
						            alert('Only digits are allowed for Adjustment Value.');
						            $(this).val(value.replace(/\D/g, '')); // Remove non-digit characters
						        }
								$('#newcost').val(value); // Automatically set New Cost to same value

						    });

						    // Validation for text fields (No special characters or numbers allowed)
						    function validateTextField(selector) {
						        $(selector).on('input', function () {
						            let value = $(this).val();
						            if (!/^[a-zA-Z\s]*$/.test(value)) {
						                alert('Only alphabets and spaces are allowed.');
						                $(this).val(value.replace(/[^a-zA-Z\s]/g, '')); // Remove special characters and numbers
						            }
						        });
						    }

						    validateTextField('#reason');
						    validateTextField('#adjustedby');
						    validateTextField('#approvedby');
						    validateTextField('#comments');
						});

	
											
						
</script>
    </div>
	
</body>
</html>