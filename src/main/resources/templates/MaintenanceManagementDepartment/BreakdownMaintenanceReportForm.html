<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Breakdown Maintenance Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/empinfo.css">
     <link rel="stylesheet" href="/css/hrms.css"> <!-- // for side bar code  -->
</head>
<body>
<!-- <div th:replace="~{WHOLESELLERANDRETAILER.html :: sidebarFragment}"></div> // for side bar code -->

<div class="form-container">
  <div class="form-section active" id="section1" style="margin-left: 20px; margin-right: 20px;">
    <h2 class="text-center mb-4">Breakdown Maintenance Report</h2>
    <br>
    <form id="breakdownmaintenancereportform">
      <input type="hidden" id="id" name="id" th:value="${report?.id}" required />

      <!-- Row 1: Equipment UID (only one field in this row) -->
      <div class="form-row">
        <div class="form-group">
          <label>Equipment Master UID <span class="text-danger">*</span></label>
            <select class="form-control" id="equipmentmasteruid" name="equipmentmasteruid" onchange="fetchEquipmentDetails(this.value)" 
                  th:if="${report == null or report.id == null}" required>
			<option value="">Select Equipment Master UID</option>
            <option th:each="uid : ${equipmentmasteruid}" th:value="${uid}" th:text="${uid}"></option>
                          
            </select>
            <input type="text" id="equipmentmasteruid" name="equipmentmasteruid" 
                 th:value="${report?.equipmentmasteruid}" 
                 onchange="fetchEquipmentDetails(this.value)" 
                 readonly th:if="${report?.id != null}">
        </div>
      </div>

      <!-- Row 2: Equipment Name & Breakdown DateTime -->
      <div class="form-row">
        <div class="form-group">
          <label>Equipment Name <span class="text-danger">*</span></label>
          <input type="text" id="equipmentname" name="equipmentname" class="form-control" readonly required />
        </div>

        <div class="form-group">
          <label>Breakdown Date and Time <span class="text-danger">*</span></label>
          <input type="datetime-local" name="breakdowndatetime" class="form-control" th:value="${report?.breakdowndatetime}" required />
        </div>
      </div>

      <!-- Row 3: Employee UID & Reported By -->
      <div class="form-row">
        <div class="form-group">
          <label for="employeeuid">Reported By (Employee UID)</label>
		    <select class="form-control" id="employeeuid" name="employeeuid" onchange="fetchEmployeeDetails(this.value)" 
                  th:if="${report == null or report.id == null}" required>
			<option value="">Select Reported By (Employee UID) </option>
            <option th:each="uid : ${employeeuid}" th:value="${uid}" th:text="${uid}"></option>
            </select>
            <input type="text" id="employeeuid" name="employeeuid" 
                 th:value="${report?.employeeuid}" 
                 onchange="fetchEmployeeDetails(this.value)" 
                 readonly th:if="${report?.id != null}">
              
        </div>

        <div class="form-group">
          <label>Reported By</label>
          <input type="text" id="first_name" name="first_name" class="form-control" readonly  />
        </div>
      </div>

      <!-- Row 4: Issue Description & Downtime Duration -->
      <div class="form-row">
        <div class="form-group">
          <label>Issue Description <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="issuedescription" name="issuedescription" th:value="${report?.issuedescription}" required>
        </div>

        <div class="form-group">
          <label>Downtime Duration (in hours) <span class="text-danger">*</span></label>
          <input type="number" class="form-control" name="downtimeduration" th:value="${report?.downtimeduration}" step="0.1" min="0" required />
        </div>
      </div>

      <!-- Row 5: Root Cause & Repaired By -->
      <div class="form-row">
        <div class="form-group">
          <label>Root Cause <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="rootcause" name="rootcause" th:value="${report?.rootcause}"  required>
        </div>

        <div class="form-group">
          <label>Repaired By <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="repairedby" name="repairedby" th:value="${report?.repairedby}"  required>
        </div>
      </div>

      <!-- Row 6: Repair Completion Date & Status -->
      <div class="form-row">
        <div class="form-group">
          <label>Repair Completion Date <span class="text-danger">*</span></label>
          <input type="date" class="form-control" id="repaircompletiondate" th:value="${report?.repaircompletiondate}" name="repaircompletiondate" required />
        </div>

        <div class="form-group">
          <label>Status <span class="text-danger">*</span></label>
          <select id="status" name="status" th:value="${report?.status}" class="form-control" required>
            <option value="">Select Status</option>
            <option value="Approved" th:selected="${report?.status == 'Approved'}">Approved</option>
            <option value="Pending" th:selected="${report?.status == 'Pending'}">Pending</option>
            <option value="Rejected" th:selected="${report?.status == 'Rejected'}">Rejected</option>
          </select>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <div class="form-group col-md-12 text-center">
          <button type="button" id="submitBtn" onclick="submitForm()">Submit</button>
           <button type="button" id="backBtn" onclick="goBack()">Back</button>
          <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
          
        </div>
      </div>
    </form>
  </div>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Auto-fill Item details when updating
    var existingemployeeuid = $('#employeeuid').val();
    if (existingemployeeuid) {
    	fetchEmployeeDetails(existingemployeeuid);
    }
});

function fetchEmployeeDetails(employeeuid) {
	  if (!employeeuid) return; 

	     $.ajax({
	 		url: '/fetchEmployeeDetailsInBreakdownMaintenanceReport',
	 		method: 'GET',
	 		data: { employeeuid: employeeuid },
	 		success: function(response) {
	 			$('#first_name').val(response.firstName);	
	 	},
	 	error:function() {
	    alert('Error fetching Employee Details. Please try again.');
	 			                }
	 							});
	 } 

	$(document).ready(function() {
	    // Auto-fill Item details when updating
	    var existingequipmentmasteruid = $('#equipmentmasteruid').val();
	    if (existingequipmentmasteruid) {
	    	fetchEquipmentDetails(existingequipmentmasteruid);
	    }
	});
	function fetchEquipmentDetails(equipmentmasteruid) {
	  if (!equipmentmasteruid) return; 

	     $.ajax({
	 		url: '/fetchEquipmentDetailsInBreakdownMaintenanceReport',
	 		method: 'GET',
	 		data: { equipmentmasteruid: equipmentmasteruid },
	 		success: function(response) {
	 			$('#equipmentname').val(response.equipmentname);	
	 	},
	 	error:function() {
	    alert('Error fetching Equipment Master Details. Please try again.');
	 			                }
	 							});
	 } 

function submitForm() {
	let form = document.getElementById('breakdownmaintenancereportform');

	if (!form.checkValidity()) {
		alert('Please fill in all required fields.');
		return;
	}

	const formData = new FormData(document.getElementById('breakdownmaintenancereportform'));
	const id = $('#id').val();

	let url, successMessage;

	if (!id) {
		url = '/savebreakdownmaintenancereport';
		successMessage = 'Breakdown maintenance report Form data saved successfully!';
	} else {
		url = '/updatebreakdownmaintenancereport';
		successMessage = 'Breakdown maintenance report Form data updated successfully!';
	}

	$
			.ajax({
				url : url,
				type : 'POST',
				data : formData,
				processData : false,
				contentType : false,
				success : function(response) {
					$('#message').text(successMessage); // Display success message
					resetForm();
					window.location.href = '/maintenancemanagementdepartment/breakdownmaintenancereportgrid';
				},
				error : function() {
					alert('Error saving Breakdown maintenance report Form . Please fill out the data.');
				}
			});
}
// Reset the form
function resetForm() {
	$('#breakdownmaintenancereportform')[0].reset();
	$('#id').val('');
	$('#message').text(''); // Clear the message
	$('#submitBtn').text('Submit');
}


    
</script>

</body>
</html>
